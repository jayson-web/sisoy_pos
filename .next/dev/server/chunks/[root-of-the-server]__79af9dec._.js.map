{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jayso/pos_sisoy/lib/db.js"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nlet pool = null;\r\n\r\nexport async function getConnection() {\r\n  if (!pool) {\r\n    pool = mysql.createPool({\r\n      host: process.env.DB_HOST || '127.0.0.1',\r\n      user: process.env.DB_USER || 'root',\r\n      password: process.env.DB_PASS || '',\r\n      database: process.env.DB_NAME || 'sisoy_booking',\r\n      port: parseInt(process.env.DB_PORT || '3306'),\r\n      waitForConnections: true,\r\n      connectionLimit: 10,\r\n      queueLimit: 0,\r\n    });\r\n  }\r\n  return pool;\r\n}\r\n\r\nexport async function query(sql, values = []) {\r\n  const pool = await getConnection();\r\n  const connection = await pool.getConnection();\r\n  try {\r\n    const [results] = await connection.execute(sql, values);\r\n    return results;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,IAAI,OAAO;AAEJ,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;YACtB,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;YAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;YAC7B,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;YACjC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;YACjC,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;YACtC,oBAAoB;YACpB,iBAAiB;YACjB,YAAY;QACd;IACF;IACA,OAAO;AACT;AAEO,eAAe,MAAM,GAAG,EAAE,SAAS,EAAE;IAC1C,MAAM,OAAO,MAAM;IACnB,MAAM,aAAa,MAAM,KAAK,aAAa;IAC3C,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jayso/pos_sisoy/app/api/bookings/route.js"],"sourcesContent":["import { query } from '@/lib/db.js';\r\n\r\nexport async function GET(request) {\r\n  try {\r\n    const searchParams = new URL(request.url).searchParams;\r\n    const action = searchParams.get('action');\r\n\r\n    if (action === 'list') {\r\n      const results = await query(`\r\n        SELECT b.*, c.first_name, c.last_name, a.name as accommodation_name,\r\n          (SELECT t.transaction_reference FROM transactions t WHERE t.booking_id = b.id ORDER BY t.id DESC LIMIT 1) AS transaction_reference,\r\n          (SELECT t.amount FROM transactions t WHERE t.booking_id = b.id ORDER BY t.id DESC LIMIT 1) AS transaction_amount\r\n        FROM bookings b\r\n        LEFT JOIN customers c ON b.customer_id = c.id\r\n        LEFT JOIN accommodations a ON b.accommodation_id = a.id\r\n        ORDER BY b.created_at DESC\r\n      `);\r\n      return Response.json({ data: results });\r\n    }\r\n\r\n    return Response.json({ error: 'Invalid action' }, { status: 400 });\r\n  } catch (error) {\r\n    console.error('Booking fetch error:', error);\r\n    return Response.json({ error: 'Failed to fetch bookings: ' + error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request) {\r\n  try {\r\n    const searchParams = new URL(request.url).searchParams;\r\n    const action = searchParams.get('action');\r\n    \r\n    if (action === 'create') {\r\n      const body = await request.json();\r\n      \r\n      // Validate required fields (accommodation_id may be non-numeric from legacy/local storage)\r\n      const required = ['customer_id', 'accommodation_id', 'check_in', 'check_out', 'guests', 'total_price'];\r\n      for (const field of required) {\r\n        if (!body[field]) {\r\n          return Response.json({ error: `${field} is required` }, { status: 400 });\r\n        }\r\n      }\r\n\r\n      // Generate booking number\r\n      const bookingNumber = `BK-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;\r\n\r\n      // Resolve accommodation_id: allow numeric id or resolve by accommodation_name for legacy/local ids\r\n      let accommodationId = parseInt(body.accommodation_id)\r\n      if (isNaN(accommodationId)) {\r\n        if (body.accommodation_name) {\r\n          const acc = await query('SELECT id FROM accommodations WHERE name = ? LIMIT 1', [body.accommodation_name])\r\n          if (acc && acc.length > 0) {\r\n            accommodationId = acc[0].id\r\n          }\r\n        }\r\n      }\r\n\r\n      if (isNaN(accommodationId)) {\r\n        return Response.json({ error: 'Invalid accommodation id' }, { status: 400 })\r\n      }\r\n\r\n      const customerId = parseInt(body.customer_id)\r\n      if (isNaN(customerId)) {\r\n        return Response.json({ error: 'Invalid customer id' }, { status: 400 })\r\n      }\r\n\r\n      const results = await query(\r\n        `INSERT INTO bookings (booking_number, customer_id, accommodation_id, check_in, check_out, guests, total_price, status, notes) \r\n         VALUES (?, ?, ?, ?, ?, ?, ?, 'confirmed', ?)`,\r\n        [\r\n          bookingNumber,\r\n          customerId,\r\n          accommodationId,\r\n          body.check_in,\r\n          body.check_out,\r\n          parseInt(body.guests),\r\n          parseFloat(body.total_price),\r\n          body.notes || '',\r\n        ]\r\n      );\r\n      const bookingId = results.insertId\r\n\r\n      // Record transaction for this booking (transactions table)\r\n      let transactionReference = `TXN-${bookingNumber}`\r\n      try {\r\n        await query(\r\n          `INSERT INTO transactions (booking_id, customer_id, amount, payment_method, status, transaction_reference, description) \r\n           VALUES (?, ?, ?, ?, 'completed', ?, ?)`,\r\n          [\r\n            bookingId,\r\n            customerId,\r\n            parseFloat(body.total_price),\r\n            body.payment_method || 'cash',\r\n            transactionReference,\r\n            `Payment for booking ${bookingNumber}`,\r\n          ]\r\n        );\r\n      } catch (txnError) {\r\n        console.error('Transaction record error (non-fatal):', txnError);\r\n      }\r\n\r\n      // Also insert into payments table for easier receipt reporting (best-effort)\r\n      try {\r\n        await query(\r\n          `INSERT INTO payments (booking_id, amount, method, status, transaction_reference) VALUES (?, ?, ?, 'paid', ?)`,\r\n          [bookingId, parseFloat(body.total_price), body.payment_method || 'cash', transactionReference]\r\n        );\r\n      } catch (payErr) {\r\n        console.error('Payments insert error (non-fatal):', payErr);\r\n      }\r\n\r\n      // Fetch the newly created booking and include last transaction info\r\n      const newBooking = await query(\r\n        `SELECT b.*, c.first_name, c.last_name, a.name as accommodation_name \r\n         FROM bookings b\r\n         LEFT JOIN customers c ON b.customer_id = c.id\r\n         LEFT JOIN accommodations a ON b.accommodation_id = a.id\r\n         WHERE b.id = ?`,\r\n        [results.insertId]\r\n      );\r\n\r\n      // Try to fetch last transaction for this booking\r\n      let lastTxn = null\r\n      try {\r\n        const txns = await query(`SELECT * FROM transactions WHERE booking_id = ? ORDER BY id DESC LIMIT 1`, [results.insertId])\r\n        if (txns && txns.length > 0) lastTxn = txns[0]\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n\r\n      return Response.json({\r\n        success: true,\r\n        id: results.insertId,\r\n        booking_number: bookingNumber,\r\n        ...newBooking[0],\r\n        transaction_reference: lastTxn ? lastTxn.transaction_reference : transactionReference,\r\n        transaction_amount: lastTxn ? lastTxn.amount : parseFloat(body.total_price),\r\n      });\r\n    }\r\n\r\n    return Response.json({ error: 'Invalid action' }, { status: 400 });\r\n  } catch (error) {\r\n    console.error('Booking error:', error);\r\n    return Response.json({ error: 'Failed to create booking: ' + error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function PATCH(request) {\r\n  try {\r\n    const searchParams = new URL(request.url).searchParams;\r\n    const id = searchParams.get('id');\r\n\r\n    if (!id) {\r\n      return Response.json({ error: 'id is required' }, { status: 400 });\r\n    }\r\n\r\n    const body = await request.json();\r\n    const updates = [];\r\n    const values = [];\r\n\r\n    // Build dynamic UPDATE statement\r\n    const allowedFields = ['status', 'check_in', 'check_out', 'guests', 'total_price', 'notes'];\r\n    for (const field of allowedFields) {\r\n      if (body[field] !== undefined && body[field] !== null) {\r\n        updates.push(`${field} = ?`);\r\n        values.push(field === 'total_price' ? parseFloat(body[field]) : body[field]);\r\n      }\r\n    }\r\n\r\n    if (updates.length === 0) {\r\n      return Response.json({ error: 'No fields to update' }, { status: 400 });\r\n    }\r\n\r\n    values.push(parseInt(id));\r\n\r\n    await query(\r\n      `UPDATE bookings SET ${updates.join(', ')} WHERE id = ?`,\r\n      values\r\n    );\r\n\r\n    // Fetch updated booking\r\n    const updatedBooking = await query(\r\n      `SELECT b.*, c.first_name, c.last_name, a.name as accommodation_name FROM bookings b\r\n       LEFT JOIN customers c ON b.customer_id = c.id\r\n       LEFT JOIN accommodations a ON b.accommodation_id = a.id\r\n       WHERE b.id = ?`,\r\n      [parseInt(id)]\r\n    );\r\n\r\n    return Response.json({\r\n      success: true,\r\n      ...updatedBooking[0],\r\n    });\r\n  } catch (error) {\r\n    console.error('Booking update error:', error);\r\n    return Response.json({ error: 'Failed to update booking: ' + error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function DELETE(request) {\r\n  try {\r\n    const searchParams = new URL(request.url).searchParams;\r\n    const id = searchParams.get('id');\r\n\r\n    if (!id) {\r\n      return Response.json({ error: 'id is required' }, { status: 400 });\r\n    }\r\n\r\n    const bookingId = parseInt(id);\r\n\r\n    // Fetch booking before deleting\r\n    const existing = await query(\r\n      'SELECT * FROM bookings WHERE id = ?',\r\n      [bookingId]\r\n    );\r\n\r\n    if (!existing || existing.length === 0) {\r\n      return Response.json({ error: 'Booking not found' }, { status: 404 });\r\n    }\r\n\r\n    // Delete related transactions first\r\n    await query('DELETE FROM transactions WHERE booking_id = ?', [bookingId]);\r\n\r\n    // Delete related payments\r\n    await query('DELETE FROM payments WHERE booking_id = ?', [bookingId]);\r\n\r\n    // Delete the booking\r\n    await query('DELETE FROM bookings WHERE id = ?', [bookingId]);\r\n\r\n    return Response.json({\r\n      success: true,\r\n      message: `Booking ${bookingId} deleted successfully`,\r\n      deleted_id: bookingId,\r\n    });\r\n  } catch (error) {\r\n    console.error('Booking delete error:', error);\r\n    return Response.json({ error: 'Failed to delete booking: ' + error.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}